#!/usr/bin/env bash

echo "Running cache test..."

BUILD_DIR=$1
CACHE_DIR=$2
BUILD_PACK_DIR=$(dirname $(dirname $0))

if [ ! -d "$BUILD_DIR" ]; then
  echo "Build directory [$BUILD_DIR] does not exist, creating"
  mkdir -p "$BUILD_DIR"
else
  echo "Build directory [$BUILD_DIR] exists"
  echo "Build directory contents..."
  ls -lRh $BUILD_DIR
fi

if [ ! -d "$CACHE_DIR" ]; then
  echo "Cache directory [$CACHE_DIR] does not exist, creating"
  mkdir -p "$CACHE_DIR"
else
  echo "Cache directory [$CACHE_DIR] exists"
fi

echo "The compile script is at [$0]"
echo "The BUILD_DIR is at [$BUILD_DIR]"
echo "The CACHE_DIR is at [$CACHE_DIR]"
echo "The build pack is situated at [$BUILD_PACK_DIR]"


echo "Creating logs directory:
mkdir $BUILD_DIR/logs

echo "Creating start script"
cat > "$BUILD_DIR/start.sh" <<EOF
#!/bin/bash

echo "working dir: $(pwd)"
echo "contents"
ls -l
echo "Home: $HOME"
export APP_ROOT=$HOME
export LOG_FILE=$APP_ROOT/logs/sc.log
echo "Log file: $LOG_FILE"
(tail -f -n 0 $LOG_FILE &)

bin/sc --user ETSLF --api-key 633246bc-bb5f-4986-a68c-4c6b7bcc4551 --proxy www-proxy.lmig.com:80 --proxy-tunnel --se-port $VCAP_APP_PORT --verbose --logfile $LOG_FILE 

EOF

chmod 770 $BUILD_DIR/start.sh

echo "Build directory contents after compile..."
ls -l $BUILD_DIR